---
title: "GP120-rabbit analysis-> (Figure 2)"
author: 
  - "Richard Barfield"
  - "Biostatistics, Epidemiology and Research Design (BERD) Core"
  - "Center for Human Systems Immunology (CHSI)"
date: "`r  Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r Baseinfo,eval=FALSE}
#General info ----------------------
#
# Created: 2022-02-03
#
# Author: Richard Barfield
#
# Program: Code/11_Figure_2_analyses.RMD
# 
# 
# Description: Analyses for Figure 2
# 

#--- --- --- --- --- --- --- --- --- --- --- --- --- 
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
```

```{r libs,message=FALSE, warning=FALSE, include=F, results='asis'}



library(nparLD)
library(stats)
library(geepack)
library(gee)
library(geesmv)
library(nlme)
library(lme4)
library(lmerTest)
library(matrixcalc)
library(knitr)
library(kableExtra)
library(tidyverse)

```

# Introduction

Reading in and processing the data into an analytical form to be used.

# Path to Data

```{r loaddata}

pathtofile<-"Data/Processed/"
pathtofile<-file.path(getwd(),"../",pathtofile)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Load the data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

Fig2.data<-readRDS(file.path(pathtofile,
                             "0_data_processed_fig2.RDS"))



```

# ELISA (Figure 2B)


```{r aim11, }


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Actual Analysis also will have the variable for what period they are in 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

FinAnalysis<-Fig2.data$Figure2_ELISA %>% filter(AUC_CV<0.2) %>% 
  mutate(BB=log10(AUC_average)) %>% 
  mutate(Newweek=as.numeric(Time)) %>% 
  mutate(T1=ifelse(Newweek>6,1,0),
         T2=ifelse(Newweek>12,1,0)) %>%
  mutate(Period=case_when(Newweek<=6~"[0,6]",
                          between(Newweek,7,12)~"[7,12]",
                          Newweek>12~"[13,+]")) %>%
  mutate(OID=paste0(ID,"_",Period))

FinFinAnalysis<-FinAnalysis %>% filter(Newweek==0) %>% 
  select(ID,BaselineAUC=BB) %>% 
  right_join(FinAnalysis %>% filter(Newweek!=0))




```

## Visualization

Visualization of the data. Plotting the mean values at each time point. Shows the 0 week even though data is not used.

```{r visualizeAim11, echo=F}


OBit<-FinAnalysis %>% group_by(Newweek,Vaccine) %>% 
  summarize(AUC_average=mean(AUC_average),.groups="drop")

FinAnalysis %>% 
  ggplot(aes(x=Newweek,y=AUC_average,col=Vaccine))+
  geom_line(aes(group=ID))+
  geom_point()+
  geom_line(data=OBit,size=3)


```

## Analysis

Adjusting for baseline as covariate in the model.

```{r baselinecov, echo=F}

TheResults<-lmer(BB~Period+Newweek+ BaselineAUC+
                   Vaccine+(1|ID)+
                     (1|ID:OID),
                 data=FinFinAnalysis)

Overall.Analysis<-anova(TheResults)
```

Overall association was `r tail(Overall.Analysis[["Pr(>F)"]],1)`.

## Checking model assumptions. Please note there is more variability in the earlier time points.

```{r plotresid}


FinFinAnalysis %>% mutate(Predicted=predict(TheResults),
                       Predicted2=predict(TheResults),
                       Residuals=resid(TheResults,type="pearson")) %>% 
  ggplot(aes(x=Predicted,y=Residuals,col=Period))+
  geom_point()+
  geom_hline(yintercept=0)


FinFinAnalysis %>% mutate(Predicted=predict(TheResults),
                       Predicted2=predict(TheResults),
                       Residuals=resid(TheResults,type="pearson")) %>% 
  ggplot(aes(x=BB,y=Predicted,col=Period))+
  geom_point()+
  xlab("Observed")+
  geom_abline(slope=1,intercept=0)

```

## Testing individual time points (exploratory secondary after previous analysis)

We will test for differences in each time period.

```{r interAim1.2, echo=F}


HH<-FinFinAnalysis %>% 
                   mutate(Vaccine1=ifelse(Period=="[0,6]"& Vaccine=="gp120-Q11+STR8S-C",
                                          1,0),
                          Vaccine2=ifelse(Period=="[7,12]"& Vaccine=="gp120-Q11+STR8S-C",
                                          1,0),
                          Vaccine3=ifelse(Period=="[13,+]" & Vaccine=="gp120-Q11+STR8S-C",
                                         1,0))

TheResults<-lmer(BB~-1+Newweek+Period+BaselineAUC+Vaccine1+Vaccine2+Vaccine3+
                   (1|ID)+
                     (1|ID:OID),
                 data=HH)



OurCoef<-summary(TheResults)$coef


OurCoef %>% as.data.frame() %>% rownames_to_column("What") %>% 
  filter(str_detect(What,"Vaccine")) %>% 
  mutate(What=case_when(What=="Vaccine1"~"Vaccine Week 0,6",
                        What=="Vaccine2"~"Vaccine Week 7,12",
                        What=="Vaccine3"~"Vaccine Week 13+")) %>% 
  mutate_if(is.numeric,signif,digits=3) %>% 
  DT::datatable(rownames=F)
  

```

No evidence of a difference across the three time points via these ELISA models.

# BAMA (Figure 2C)

Please ignore the computational output, can not suppress.

```{r analysis, echo=F}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Sourcing the function to calculate general Bias Corrected variance
# for GEE
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
source("1_general_code_for_calc_BC_variance.R")




ForAnalysis<-Fig2.data$Figure2_BAMA %>% select(-Description,-What) %>% 
  pivot_longer(cols=c(-Week,-Rabbit,-Vaccine)) %>% 
  mutate(Vaccine=ifelse(str_detect(Vaccine,"gp120-Q11"),1,0)) %>% 
  filter(!is.na(value)) %>% 
  mutate(Week=factor(Week,levels=c("2","8","14"))) %>% 
  filter(name %in% c("B. con_env03_gp140 (30)",
                     "1086c D7gp120K160N (11)",
                     "MNgp120 gDneg (18)",
                     "A244gp120 gDneg (38)",
                     "A. con_env03_gp140 (24)"))
  
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Set formula
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
my.formula<-BB~-1+name+Week*Vaccine  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get Data in proper form
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
NewGEE<-ForAnalysis %>% 
  mutate(Rabbit=str_sub(Rabbit,2,-1)) %>% 
  mutate(BB=log10(value))

NewGEE$subject<-NewGEE$Rabbit
NewGEE$id<-NewGEE$Rabbit
NewGEE<-NewGEE[order(NewGEE$subject),]


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Pass to the Bias corrected function 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

NewResus<-MyGee.Var.MD(my.formula,id="id",
                       family=stats::gaussian,
                       data=NewGEE)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Set up Contrasts 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Contrast.est2<-matrix(0,nrow=3,ncol=length(NewResus$beta_est))

Contrast.est2[1:3,which(str_detect(names(NewResus$beta_est),"Vaccine") &
                          str_detect(names(NewResus$beta_est),"Week",negate=T))]<-1

Contrast.est2[2,which(str_detect(names(NewResus$beta_est),"Vaccine") &
                          str_detect(names(NewResus$beta_est),"Week8"))]<-1
Contrast.est2[3,which(str_detect(names(NewResus$beta_est),"Vaccine") &
                          str_detect(names(NewResus$beta_est),"Week14"))]<-1

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Calculate variance
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Our.Var<-Contrast.est2 %*% NewResus$cov.beta  %*% t(Contrast.est2)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Calculate effects 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Our.New.effects<-Contrast.est2 %*%NewResus$beta_est


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Calculate tests  and p-values 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Overall.test<-t(Our.New.effects) %*% solve(Our.Var) %*% Our.New.effects
Overall.Pvalue<-pchisq(Overall.test[1,1],df=3,lower.tail=F)

Ind.Pvalues<-pchisq(Our.New.effects^2/diag(Our.Var),df=1,lower.tail=F)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Output 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
data.frame(What=c("Week 2 Vaccine: Q11 vs no","Week 8 Vaccine: Q11 vs no",
                  "Week 14 Vaccine: Q11 vs no"),stringsAsFactors = F) %>% 
  mutate(Effect_Estimate=Our.New.effects,
         Effect_Std=sqrt(diag(Our.Var)),
         Effect_Pvalue=Ind.Pvalues,
         Effect_Adjust_Pvalue=p.adjust(Ind.Pvalues,"bonferroni")) %>% 
  DT::datatable(rownames = F) %>% 
  DT::formatSignif(c("Effect_Estimate","Effect_Std","Effect_Pvalue","Effect_Adjust_Pvalue"))

```

We have evidence of a difference after adjustment for multiple testing in week 2 but not at the later time points.

## Visualization

```{r visualize, echo=F}

NewGEE %>% select(-Vaccine) %>% 
  mutate(Rabbit=paste0("N",Rabbit)) %>% 
  mutate(Week=paste("Week",Week)) %>% 
  mutate(Week=factor(Week,levels=c("Week 2","Week 8","Week 14"))) %>% 
  left_join(Fig2.data$Figure2_BAMA %>% 
              select(Rabbit,Vaccine) %>%
              distinct()) %>% 
  ggplot(aes(x=name,y=value,col=Vaccine))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position=position_jitterdodge(0.1,seed=4154))+
  facet_wrap(~Week)+
  scale_y_log10()+
  theme(axis.text.x = element_text(angle=90))+
  coord_flip()+
  theme(legend.position = "bottom")+
  ylab("Bama Value")+
  xlab("Bama Antigen")

```

# Infected Cell Binding (Figure 2D)

```{r Aim13, echo=F}

Infect.data<-Fig2.data$Figure2_Binding

ForAnalysis<-Infect.data %>% 
  pivot_longer(cols=c("MFI zero corrected","% infected cell binding zero corrected"))



ForAnalysis %>%
  ggplot(aes(log10(value+1))) +
  geom_histogram()+
  facet_wrap(~name,scales="free_y")

  
```

Given that will fit a non-parametric longitudinal data.

We adjusted for week 0 by offsetting the data by the week 0 value.

### Visualization Normalize by week 0 (subtract off week 0)

```{r visualizelastonenorm, echo=F}

ForAnalysis %>% 
  filter(week_challenge!="Week 0") %>% 
  right_join(ForAnalysis %>% filter(week_challenge=="Week 0") %>% 
               select(animal_no,name,basevalue=value)) %>% 
  mutate(Newvalue=value-basevalue) %>% 
  mutate(Week=factor(week_challenge,levels=c("Week 2","Week 8",
                                             "Week 14","Week 21"))) %>% 
  ggplot(aes(x=Week,y=Newvalue,
             col=Vaccine))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position=position_jitterdodge(0.05,seed=4154))+
  facet_wrap(~name,nrow=2,scales="free_y")
  

```

## Analysis

```{r nparldthisone, options}

NewAnalysis<-ForAnalysis%>% 
  filter(week_challenge!="Week 0") %>% 
  right_join(ForAnalysis %>% filter(week_challenge=="Week 0") %>% 
               select(animal_no,name,basevalue=value)) %>% 
  rename("subject"=animal_no) %>% 
  mutate(Week=as.character(week_challenge )) %>% 
  mutate(Newvalue=value-basevalue)

Resu.MFI<-nparLD(Newvalue~Week+Vaccine,time1.order = c("Week 2",
                                                      "Week 8",
                                                      "Week 14",
                                                      "Week 21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=NewAnalysis %>% filter(name=="MFI zero corrected"))
            


Resu.Other<-nparLD(Newvalue~Week+Vaccine,time1.order = c("Week 2",
                                                      "Week 8",
                                                      "Week 14",
                                                      "Week 21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=NewAnalysis %>% filter(name!="MFI zero corrected"))


            

data.frame(Pvalues=c(signif(Resu.MFI$ANOVA.test.mod.Box[4],3),
                     signif(Resu.Other$ANOVA.test.mod.Box[4],3))) %>% 
  mutate(What=c("MFI zero corrected","% infected cell binding zero corrected")) %>% 
  select("What","Pvalues") %>% 
  mutate(FDR_Pvalue=p.adjust(Pvalues,"BH")) %>% 
  kable() %>% kable_styling(full_width = F)
```

After multiple testing correction, there appears to be statistical evidence at the 0.05 level of differences between the vaccine groups over time after subtracting off the week 0 value.



# Session Info

```{r sessioninfo}
sessionInfo()
```
