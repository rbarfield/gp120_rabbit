---
title: "Reading and Processing data for GP120-rabbit analysis"
author: 
  - "Richard Barfield"
  - "Biostatistics, Epidemiology and Research Design (BERD) Core"
  - "Center for Human Systems Immunology (CHSI)"
date: "`r  Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Baseinfo,eval=FALSE}
#General info ----------------------
#
# Created: 2022-02-02
#
# Author: Richard Barfield
#
# Program: Code/0_processing_qc_data
# 
# Description: Reading in and processing the data
# 
# 
# Modified 2022-02-03: Updating to output corresponding items as originally the planned figures 
#                      were in a slightly different order. 
#                      
# Modified 2022-02-04: Updating kd properly.                       
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
```

```{r libs,message=FALSE, warning=FALSE, include=F, results='asis'}

library(lubridate)
library(DescTools)
library(table1)
library(readxl)
library(knitr)
library(kableExtra)
library(tidyxl)
library(tidyverse)

```

# Introduction


Reading in and processing the data into an analytical form to be used   

# Path to Data

```{r loaddata}

pathtofile<-"Data/Original"
pathtofile<-file.path(getwd(),"../",pathtofile)

pathtosave<-"Data/Processed/"
pathtosave<-file.path(getwd(),"../",pathtosave)


```



# Figure 2



## Figure 2 ELISA

```{r Fig2elisa, echo=T}


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next the ELISA and calculating the AUC
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
New.ELISA<-str_subset(list.files(file.path(pathtofile,"Figure2/")),"ELISA")


Fig2.Elisa<-read_excel(file.path(pathtofile,"Figure2/",New.ELISA))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Give them new names based on that
#  concentration they were measured at this involves 
#  taking the first columns. Filling in when duplicate and 
#  then taking the second row which has the concentration info
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

HoldThis.here<-colnames(Fig2.Elisa) %>% 
  data.frame(stringsAsFactors = F) %>% 
  rename_all(~"V1") %>% 
  mutate(V1=ifelse(str_detect(V1,"OD"),V1,NA)) %>% 
  fill(V1) %>% 
  mutate(V2=Fig2.Elisa %>% slice(1) %>% unlist()) %>% 
  mutate(GotIt=paste(V1,V2,sep="_")) %>% 
  mutate(GotIt=ifelse(str_detect(GotIt,"NA"),V2,GotIt)) %>% 
  mutate(GotIt=ifelse(is.na(GotIt),"Time_character",GotIt))
  

Elisa.2<-Fig2.Elisa %>% 
  rename_all(~HoldThis.here$GotIt) %>% 
  slice(-1) %>% 
  fill(Time_character) %>% 
  pivot_longer(cols=(contains("OD"))) %>% 
  mutate(What=str_squish(str_split_fixed(name,"OD",2)[,1])) %>% 
  mutate(Dilution_value=str_split_fixed(name,"OD",2)[,2]) %>% 
  mutate(Dilution_value=str_remove_all(Dilution_value,"value_|_")) %>% 
  mutate(Dilution_value=parse_number(Dilution_value)) 
  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get everything together for getting the CV and what not
# 
# we get the max cv amongst all the duplicates
# Also measure the CV of the AUC because I'm curious. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

Fig2.Save.Elisa<-Elisa.2 %>% 
  filter(What!="Average") %>% 
  group_by(Time_character,`rabbit ID`,Dilution_value) %>% 
  mutate(CV=abs(diff(value))/sum(value)) %>% 
  mutate(Av=mean(value)) %>% 
  ungroup() %>% 
  select(ID=`rabbit ID`,
         Time=`Time (week)`,
         Time2=Time_character,
         Vaccine=Vaccine,
         value,
         What,
         Dilution_value,
         CV,
         Av) %>% 
  group_by(ID,Time2) %>% 
  mutate(max_CV=max(CV)) %>% 
  group_by(ID,Time2,What,Vaccine) %>% 
  mutate(AUC1=AUC(x=log10(Dilution_value),value)) %>% 
  select(-value) %>% 
  pivot_wider(values_from=AUC1,names_from = What,
              names_prefix = "AUC") %>% 
  group_by(ID,Time2,Vaccine) %>% 
  select(ID,Time,Time2,Vaccine,max_CV,
         starts_with("AUC")) %>% ungroup() %>% 
  distinct() %>% 
  mutate(AUC_CV=abs(AUCDuplicate1-AUCDuplicate2)/mean(AUCDuplicate1+AUCDuplicate2)) %>% 
  mutate(AUC_average=(AUCDuplicate1+AUCDuplicate2)/2) %>% 
  filter(AUC_CV<0.2) 


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Putting aside the vaccine information to use later
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

OurVaccine.info<-Fig2.Save.Elisa %>% select(Rabbit=ID,Vaccine) %>% 
  distinct() %>% 
  mutate(Vaccine=recode(Vaccine,
                        "gp120+STR8S-C"="gp120+STR8S-C (-Q11)",
                        "gp120-Q11+STR8S-C"="gp120-Q11+STR8S-C (+Q11)"))

  

```



## Figure 2 Bama

```{r bamadata, echo=T}


Val1<-list.files(file.path(pathtofile,"Figure2"))

NewFiles<-str_subset(Val1,
                     "breadth")



File1<-read_excel(file.path(pathtofile,"Figure2/",
                            NewFiles[1]),"FI - Bkgd")
File2<-read_excel(file.path(pathtofile,"Figure2/",
                            NewFiles[2]),"FI - Bkgd")  


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Subset to the necessary info and derive proper names
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- 
      # First File 1
      # Grabbing the second set of data and calculating the CV
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      
      NewFile<-File1 %>%
        slice((str_which(.[[1]],"Type")[2]-1):n())

      colnames(NewFile)<-c(NewFile[2,1:3] %>% unlist(),
                     NewFile[1,] %>% c() %>% unlist() %>%
                       na.omit())
      
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # This drops the first two rows (which are empty) 
      # and then drops the bottom rows which have excess stuff 
      # 
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      
      Fin.File.1<-NewFile %>% slice(-(1:2)) %>% 
        filter(rowSums(!is.na(.))>1) %>% 
        mutate_at(4:ncol(.),as.numeric)
      
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # File 2 
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      
      NewFile<-File2 %>% slice((str_which(.[[1]],"Type")[2]-1):n())

      colnames(NewFile)<-c(NewFile[2,1:3] %>% unlist(),
                     NewFile[1,] %>% c() %>% unlist() %>% na.omit())
      
      Fin.File.2<-NewFile %>% slice(-(1:2)) %>% 
        filter(rowSums(!is.na(.))>1) %>% 
        mutate_at(4:ncol(.),as.numeric)
      
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # Put together
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      
      Fig2.Bama<-Fin.File.1 %>% mutate(What=NewFiles[1]) %>% 
        bind_rows(Fin.File.2 %>% mutate(What=NewFiles[2]))
      
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next QC and finding the CV and dropping samples 
# that do not have a CV greater than 0.2 
# dropping the blank column 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---      
      
      
      Fig2.save.Bama<-Fig2.Bama %>% 
        filter(str_detect(Description,"wk")) %>% 
        select(-starts_with("Blank")) %>% 
        pivot_longer(cols = c(-Type,-Well,
                              -Description,-What)) %>% 
        group_by(Description,What,name) %>% 
        summarize(MeanVal=mean(value),
                  CV=abs(diff(value))/sum(value),
                  .groups = "drop") %>% 
        filter(CV<0.2) %>% 
        select(-CV) %>% 
        pivot_wider(values_from=MeanVal,names_from=name) %>% 
        mutate(Week=parse_number(str_remove_all(str_split_fixed(Description,"N",2)[,1],
                                                "wk")),
               Rabbit=str_split_fixed(Description,
                                        "[[:blank:]]",2)[,2]) %>% 
        select(Description,Rabbit,Week,everything()) %>% 
        arrange(Week) %>% 
        left_join(OurVaccine.info) 

```



## Figure 2 Infected cell binding

```{r fig2binding, echo=T}

New.binding<-str_subset(list.files(file.path(pathtofile,
                                             "Figure2/")),
                        "_infected cell binding")


Fig2.B<-read_excel(file.path(pathtofile,"Figure2/",New.binding))

Fig2.bind.save<-Fig2.B %>% 
  filter(str_detect(week_challenge,"Assay",negate=T))




```


## Figure 2 Save everything out

```{r savethis, echo=T}

Fig2.all<-list(Figure2_BAMA=Fig2.save.Bama,
               Figure2_ELISA=Fig2.Save.Elisa,
               Figure2_Binding=Fig2.bind.save)


saveRDS(Fig2.all,
        file = file.path(pathtosave,"0_data_processed_fig2.RDS"))

```



# Figure 3


## Figure 3 wk 14 IgG

```{r Fig3A, echo=T}

Fig3.add<-list.files(file.path(pathtofile,
                               "Figure3 additional"),
                      full.names = T)

Fig3A<-read_excel(Fig3.add)




```

## Figure 3 ADCP    

```{r Fig3, echo=T}


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# First the ADCP:Antibody Dependent cellular phagocytosis
# Data is across three different sheets. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
New.fig3<-str_subset(list.files(file.path(pathtofile,
                                          "Figure3/")),"ADCP")

To_read_in <- excel_sheets(file.path(pathtofile,"Figure3/",
                                     New.fig3))

Temp.Data<-lapply(To_read_in,
                  function(x) read_excel(file.path(pathtofile,
                                                   "Figure3/",
                                                   New.fig3),
                                                    sheet=x) %>% 
                      mutate(What=x) %>%
                    rename_at(vars(contains("set")),
                              ~c("Set1","Set2")))


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# So we will have the mean of the two runs as well as the CV
# will drop those with CV above 0.2
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Fig3.Save.ADCP<-Temp.Data %>% bind_rows() %>% 
  fill(Vaccination) %>% 
  select(Vaccination,ID="Sample:",Time,
         Set1,Set2,
         What) %>% 
  mutate(CV=abs(Set1-Set2)/(Set1+Set2),
         Mean=Set1/2+Set2/2) %>% 
  filter(str_detect(Time,"w"))
  

```


## Figure 3 ADCC

```{r fig3adcc, echo=T}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# The ADCC: Antibody-induced death of infected-cells 
# Very similar bunch of different sheets
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
New.fig3<-str_subset(list.files(file.path(pathtofile,
                                          "Figure3/")),
                     "ADCC_June14")

To_read_in <- excel_sheets(file.path(pathtofile,
                                     "Figure3/",
                                     New.fig3))

Temp.Data<-lapply(To_read_in,
                  function(x) read_excel(file.path(pathtofile,
                                                   "Figure3/",New.fig3),sheet=x) %>% 
                      mutate(What=x))

Fig3.Save.ADCC<-Temp.Data %>% bind_rows() %>% 
  rename(subject=`Animal ID`) %>% 
  left_join(OurVaccine.info %>% rename("subject"=Rabbit,
                                       Vaccine=Vaccine)) 

  

```



## Figure 3 save    
 
```{r saveFig3, echo=T}

Fig3.all<-list(Figure3_ADCC=Fig3.Save.ADCC,
               Figure3_ADCP=Fig3.Save.ADCP,
               Figure3_IgGA=Fig3A)


saveRDS(Fig3.all,
        file = file.path(pathtosave,"0_data_processed_fig3.RDS"))

```


# Figure 4


## FIgure 4C

### First GP120 specific

```{r Figure4B,}

Fig4.wk14gp120<-str_subset(list.files(file.path(pathtofile, 
                                          "Figure5/")), 
                     "Figure5 glycan gp120-specific wk14")

Our.sheets<-str_subset(excel_sheets(file.path(pathtofile,
                                             "Figure5/",Fig4.wk14gp120)),
                      "Avg assay1_2")


Our.Data<-read_excel(file.path(pathtofile,"Figure5/",
                              Fig4.wk14gp120),
                    sheet=Our.sheets)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get this data into a slightly better format
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---


HoldThis<-Our.Data %>% fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is")
  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# get the names for the average info. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

PutAside<-HoldThis %>% filter(!is.na(.[[2]])) %>% 
  select_if(~!(all(is.na(.)))) %>% 
  select_if(~!(all(.=="%"))) %>% 
  mutate(ID=str_remove_all(ID,"wk14_")) %>% 
  mutate_at(vars(-c("What_Is","ID")),as.numeric) %>% 
  select(-2)


NewMean.and.CV<-PutAside %>% 
  filter(str_detect(What_Is,"Average",negate=T)) %>% 
  pivot_longer(cols=c(-ID,-What_Is)) %>% 
  mutate(newID=str_split_fixed(ID,"_",2)[,1]) %>% 
  filter(!is.na(value)) %>% 
  group_by(newID,name) %>% 
  summarize(MeanValue=mean(value),
            N=n(),
            CV=abs(diff(value))/sum(value),.groups="drop")


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next the other data of interest conglomerate he has 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---



New.Data<-read_excel(file.path(pathtofile,"Figure5/",
                               Fig4.wk14gp120),
                     sheet=Our.sheets,
                     skip =str_which(Our.Data[[1]],
                                     "Average")-2 )%>% 
  fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is") %>% 
  select(-2,-4) %>% 
  select(which(colMeans(is.na(.))<1)) %>%
  filter(!is.na(ID)) %>% 
  select_if(~!(all(.=="%"))) 
  


New.Conglom<- New.Data %>% select(What_Is,ID,
                                  any_of(setdiff(colnames(New.Data),
                                                 unique(NewMean.and.CV$name)))) %>% 
  pivot_longer(cols=c(-ID,-What_Is),names_to="name",values_to = "MeanValue") %>% 
  mutate(What_Is="Conglomerate")



Fig4.IgC.glycan.wk14<-NewMean.and.CV %>% 
  rename(ID=newID) %>% 
  select(-N) %>% 
  mutate(What_Is="Individual") %>% 
  bind_rows(New.Conglom) %>% mutate(Week=14) %>% 
  mutate(ID=str_split_fixed(ID,"_",2)[,1]) %>% 
  left_join(OurVaccine.info %>% rename(ID=`Rabbit`))






```




### Total IgG at week 0


```{r totalIgGwk0, options}


New.fig4total<-str_subset(list.files(file.path(pathtofile,
                                          "Figure5/")),
                     "Figure5 total IgG Fc wk0")

Our.sheets<-str_subset(excel_sheets(file.path(pathtofile,
                                             "Figure5/",
                                             New.fig4total)),"\\+")


Our.Data<-read_excel(file.path(pathtofile,"Figure5/",New.fig4total),sheet=Our.sheets)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get this data into a slightly better format
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---


HoldThis<-Our.Data %>% fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is")
  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# get the names for the average info. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

PutAside<-HoldThis %>% filter(!is.na(.[[2]])) %>% 
  select(-2,-4) %>% 
  mutate(ID=str_remove_all(ID,"wk0_whole_IgG_Fc_")) %>% 
  mutate_at(vars(-c("What_Is","ID")),as.numeric)


NewMean.and.CV<-PutAside %>% 
  filter(str_detect(What_Is,"Average",negate=T)) %>% 
  pivot_longer(cols=c(-ID,-What_Is)) %>% 
  mutate(newID=str_split_fixed(ID,"_",2)[,1]) %>% 
  filter(!is.na(value)) %>% 
  group_by(newID,name) %>% 
  summarize(MeanValue=mean(value),
            CV=abs(diff(value))/sum(value),.groups="drop")


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next the other data of interest the weird conglomerate he has and append to above 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---



New.Data<-read_excel(file.path(pathtofile,"Figure5/",
                               New.fig4total),
                     sheet=Our.sheets,
                     skip =str_which(Our.Data[[1]],
                                     "Average")-1 )%>% fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is") %>% 
  select(-2,-4) %>% 
  select(which(colMeans(is.na(.))<1))
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Drop this G1F[3]/G1FB[6] as that is a typo and meant to be
# G1FB[6]/G1F[3]
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

New.Conglom<- New.Data %>% select(What_Is,ID,
                                  any_of(setdiff(colnames(New.Data),
                                                 unique(NewMean.and.CV$name)))) %>% 
  pivot_longer(cols=c(-ID,-What_Is),names_to="name",values_to = "MeanValue") %>% 
  mutate(What_Is="Conglomerate") %>% 
  filter(str_detect(name,"IgG"))


Fig4.IgC.wk0<-NewMean.and.CV %>%  rename(ID=newID) %>% 
  mutate(What_Is="Individual") %>% 
  bind_rows(New.Conglom) %>% mutate(Week=0)%>% 
  mutate(ID=str_split_fixed(ID,"_",2)[,1]) %>% 
  left_join(OurVaccine.info %>% rename(ID=`Rabbit`))



```



## Figure 4 save it out




```{r saveFig5, echo=T}

Fig4.all<-list(Figure4_total_wk0=Fig4.IgC.wk0,
               #Figure5_total_wk14=Fig5.IgC.wk14,
               Figure4_glycan=Fig4.IgC.glycan.wk14)
               #Figure5_heatmap=Fig5.corr.analysis)


saveRDS(Fig4.all,
        file = file.path(pathtosave,"0_data_processed_fig4.RDS"))

```




## Figure 4 binding

```{r fig4binding, echo=T}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# This one will be a pain.
# Have to go through the different sheets. 
# Grab the occasional ones where they were repeated and
# what not. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
New.fig4<-str_subset(list.files(file.path(pathtofile,
                                          "Figure4/")),
                     "rabbit FcR binding")

Fig4.save.spr<-lapply(New.fig4,
                      function(x) read_excel(file.path(pathtofile, "Figure4/",
                                                       x),
                                             sheet="FI - Bkgd") %>% 
                        mutate(What=x))

Orig.info<-lapply(New.fig4,function(x) read_excel(file.path(pathtofile,
                                                                "Figure4/",x),
                                                      sheet="FI") %>% 
                        mutate(What=x))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Make a function to go through and clean some of these
# Grabbing the second half where the duplicates are
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

    my.func<-function(x){
      tt<-str_which(x[[1]],"Type")
      newcolnames<-x %>% slice(tt[2]) %>% unlist() %>% unname
      exist<-which(colnames(x)=="What")
      newcolnames[exist]<-"What"
      
      
      newcolnames2<-x %>% slice(tt[1]-1) %>% unlist() %>% unname
      newcolnames2[which(newcolnames=="What")]<-""
      newcolnames2[which(is.na(newcolnames2))]<-""
      Finnames<-paste0(newcolnames," ",newcolnames2)
      
      
      newx<-x %>% slice((tt[[2]]+1):n()) %>% 
        rename_all(~str_squish(Finnames)) %>% 
        mutate_at(vars(starts_with("FI")),as.numeric)
      return(newx)
      
    }
    

  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  # Now run 
  # Read in the data before the correction due to wanting
  # to calculate the CV. 
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    

    
    All.Things<-lapply(Fig4.save.spr,my.func) %>% bind_rows()
    
    
    All.Things.2<-lapply(Orig.info,my.func) %>% bind_rows()
    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next we will go through and calculate the CV, puting the blank 
# corrected that are negative at 0, also dropping the controls
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    
    
    Actual_CV<-All.Things.2 %>% 
      filter(str_detect(Description,"naive|BIVIG",negate=T)) %>% 
      mutate_at(vars(starts_with("FI")),~ifelse(.<0,0,.)) %>% 
      select(-contains("Blank")) %>% 
      rename_at(vars(starts_with("FI")),~"FI") %>% 
      group_by(Description,What) %>% 
      summarize(CV=abs(diff(FI))/sum(FI),
                N=n(),.groups="drop")
  
    Actual_CV %>% filter(abs(CV)>=0.2) %>%
      knitr::kable() %>% 
      kableExtra::kable_styling()
    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Actual Data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---  
    Fig4.data.for.saving<- All.Things %>% 
      filter(str_detect(Description,"naive|BIVIG",negate=T)) %>% 
      mutate_at(vars(starts_with("FI")),~ifelse(.<0,0,.)) %>% 
      select(-contains("Blank")) %>% 
      rename_at(vars(starts_with("FI")),~"FI") %>% 
      group_by(Description,What) %>% 
      summarize(Mean_val=mean(FI),
                TheWell=paste(Well,collapse=","),
                .groups="drop") %>% 
      left_join(Actual_CV %>% select(-N))
    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Assess for the repeats and only keep those values
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---  
  
    Fig4.data.for.saving_fin<-Fig4.data.for.saving %>% 
      mutate(IsRepeat=ifelse(str_sub(Description,-1,-1)=="R",
                             1,0)) %>% 
      mutate(Actual_Mouse=str_remove_all(Description,"R")) %>% 
      mutate(WhatWeek=str_split_fixed(Actual_Mouse,
                                      "_",2)[,2]) %>% 
      mutate(WhatWeek=str_remove_all(WhatWeek,"wk")) %>% 
      select(Actual_Mouse,WhatWeek,What,TheWell,IsRepeat,
             Mean_val,CV)

      
    
    
    
```


## Figure 4 Correlation matrix

```{r Fig4.cor, echo=T}

New.fig4<-str_subset(list.files(file.path(pathtofile,"Figure4/")),"correlation")

Figure.4.cor<-read_excel(file.path(pathtofile,"Figure4/",New.fig4))



#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get the information on the column location 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
    TheInfo.on.col.location<-tidyxl::xlsx_cells(file.path(pathtofile,"Figure4/",New.fig4)) %>% 
      filter(data_type=="character") %>% 
      filter(row==1) 
    
    Our.Info<-TheInfo.on.col.location %>% 
      select(What=sheet,address,row,col,name=character)
    
    
    Fig4.corr.analysis<-Figure.4.cor %>% 
      mutate_all(as.character) %>% 
      pivot_longer(cols=c(-`Animal ID`)) %>% 
      left_join(Our.Info)

    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next get the columns this dude wants
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    

Letters1 <- LETTERS[which(LETTERS=="B"):which(LETTERS=="N")]  


    
Fig4.corr.analysis<-Fig4.corr.analysis %>% 
  mutate(NewAddress=str_sub(address,1,-2)) %>% 
  mutate(Response1=ifelse(NewAddress %in% Letters1,
                          "13 variables","57 variables"))

```




## Figure 4 save out

```{r saveFig4, echo=T}
# 
# Fig4.all<-list(Figure4_spr=Fig4.actual_save.spr,
#                Figure4_binding=Fig4.data.for.saving,
#                Figure4_heatmap=Fig4.corr.analysis)
# 
# 
# saveRDS(Fig4.all,
#         file = file.path(pathtosave,"0_data_processed_fig4.RDS"))

```




# Figure 5





## Figure 5 Mouse Information


```{r fig4_addi, options}


TheFile <- file.path(
  pathtofile,
  "Figure4 additional/Figure5 gp120-Q11 mouse gp120-specific IgG_summary_updated.xlsx"
)

New.data<-read_excel(TheFile)


other.file <- file.path(
  pathtofile,
  "Figure4 additional/Figure5_gp120-Q11_mouse total IgG glycan_summary_updated.xlsx"
)



New.data_2<-read_excel(other.file)


```



## Save it out

```{r saveout, echo=F}



Fig5.data<-list(Figure5_gp120=New.data,
                      Figure5_total=New.data_2)


saveRDS(Fig5.data,
        file = file.path(pathtosave,
                         "0_data_processed_fig5.RDS"))



```



## Figure5 total IgG Fc wk14 

```{r Fig5_total_wk14, echo=T}

New.fig5<-str_subset(list.files(file.path(pathtofile,"Figure5/")),"Figure5 total IgG Fc wk14")

Our.sheets<-str_subset(excel_sheets(file.path(pathtofile,"Figure5/",New.fig5)),"\\+")


Our.Data<-read_excel(file.path(pathtofile,"Figure5/",New.fig5),sheet=Our.sheets)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get this data into a slightly better format
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---


HoldThis<-Our.Data %>% fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is")
  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# get the names for the average info. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

PutAside<-HoldThis %>% filter(!is.na(.[[2]])) %>% 
  select(-2,-4) %>% 
  mutate(ID=str_remove_all(ID,"wk14_total_IgG_")) %>% 
  mutate(ID=str_remove_all(ID,"wk14_")) %>% 
  mutate_at(vars(-c("What_Is","ID")),as.numeric)


NewMean.and.CV<-PutAside %>% 
  filter(str_detect(What_Is,"Average",negate=T)) %>% 
  pivot_longer(cols=c(-ID,-What_Is)) %>% 
  mutate(newID=str_split_fixed(ID,"_",2)[,1]) %>% 
  filter(!is.na(value)) %>% 
  group_by(newID,name) %>% 
  summarize(MeanValue=mean(value),
            N=n(),
            CV=abs(diff(value))/sum(value),.groups="drop")


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next the other data of interest the weird conglomerate he has 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---



New.Data<-read_excel(file.path(pathtofile,"Figure5/",New.fig5),sheet=Our.sheets,
                     skip =str_which(Our.Data[[1]],"Average")-1 )%>% fill(1) %>% 
  rename_at(3,~"ID") %>% 
  rename_at(1,~"What_Is") %>% 
  select(-2,-4) %>% 
  select(which(colMeans(is.na(.))<1))


New.Conglom<- New.Data %>% select(What_Is,ID,
                                  any_of(setdiff(colnames(New.Data),
                                                 unique(NewMean.and.CV$name)))) %>% 
  pivot_longer(cols=c(-ID,-What_Is),names_to="name",values_to = "MeanValue") %>% 
  mutate(What_Is="Conglomerate")%>% 
  filter(str_detect(name,"IgG"))



Fig5.IgC.wk14<-NewMean.and.CV %>%  rename(ID=newID) %>% 
  mutate(What_Is="Individual") %>% 
  bind_rows(New.Conglom) %>% mutate(Week=14)

```


# Figure 6 

## Figure 6 Correlation information 

Again, seems to be an overly complicated analysis, with too many features 


```{r FinFig5, options}

New.fig6<-str_subset(list.files(file.path(pathtofile,
                                          "Figure5/")),
                     "Figure5 glycan-function correlation")

Our.sheets<-excel_sheets(file.path(pathtofile,"Figure5/",New.fig6))


Our.Data<-lapply(Our.sheets,function(x){
        read_excel(file.path(pathtofile,"Figure5/",New.fig6),
                   sheet=x) %>% 
    mutate(What=x)
  }
  )


TheInfo.on.col.location<-tidyxl::xlsx_cells(file.path(pathtofile,
                                                      "Figure5/",
                                                      New.fig6)) %>% 
  filter(data_type=="character") %>% 
  filter(row==1) 

Our.Info<-TheInfo.on.col.location %>% 
  select(What=sheet,address,row,col,name=character)


Fig6.corr.analysis<-Our.Data %>% bind_rows() %>% 
  pivot_longer(cols=c(-`Animal ID`,-What)) %>% 
  left_join(Our.Info)



```

## Figure 6 save it out




```{r saveFig6, echo=T}

Fig6.all<-list(Figure6heatmap=Fig6.corr.analysis)


saveRDS(Fig6.all,
        file = file.path(pathtosave,"0_data_processed_fig6.RDS"))

```

# Supplement Figure



## Figure S6A

```{r fig6Abinding, echo=T}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# This one will be a pain.
# Have to go through the different sheets. 
# Grab the occasional ones where they were repeated and
# what not. 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---


New.figS6A<-str_subset(list.files(file.path(pathtofile,
                                          "Figure4/")),
                     "rabbit FcR binding")

FigS6A.save.spr<-lapply(New.figS6A,
                      function(x) read_excel(file.path(pathtofile, "Figure4/",
                                                       x),
                                             sheet="FI - Bkgd") %>% 
                        mutate(What=x))

Orig.info<-lapply(New.figS6A,function(x) read_excel(file.path(pathtofile,
                                                                "Figure4/",x),
                                                      sheet="FI") %>% 
                        mutate(What=x))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Make a function to go through and clean some of these
# Grabbing the second half where the duplicates are
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

    my.func<-function(x){
      tt<-str_which(x[[1]],"Type")
      newcolnames<-x %>% slice(tt[2]) %>% unlist() %>% unname
      exist<-which(colnames(x)=="What")
      newcolnames[exist]<-"What"
      
      
      newcolnames2<-x %>% slice(tt[1]-1) %>% unlist() %>% unname
      newcolnames2[which(newcolnames=="What")]<-""
      newcolnames2[which(is.na(newcolnames2))]<-""
      Finnames<-paste0(newcolnames," ",newcolnames2)
      
      
      newx<-x %>% slice((tt[[2]]+1):n()) %>% 
        rename_all(~str_squish(Finnames)) %>% 
        mutate_at(vars(starts_with("FI")),as.numeric)
      return(newx)
      
    }
    

  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  # Now run 
  # Read in the data before the correction due to wanting
  # to calculate the CV. 
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    

    
    All.Things<-lapply(FigS6A.save.spr,my.func) %>% bind_rows()
    
    
    All.Things.2<-lapply(Orig.info,my.func) %>% bind_rows()
    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Next we will go through and calculate the CV, puting the blank 
# corrected that are negative at 0, also dropping the controls
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    
    
    Actual_CV<-All.Things.2 %>% 
      filter(str_detect(Description,"naive|BIVIG",negate=T)) %>% 
      mutate_at(vars(starts_with("FI")),~ifelse(.<0,0,.)) %>% 
      select(-contains("Blank")) %>% 
      rename_at(vars(starts_with("FI")),~"FI") %>% 
      group_by(Description,What) %>% 
      summarize(CV=abs(diff(FI))/sum(FI),
                N=n(),.groups="drop")
  
    Actual_CV %>% filter(abs(CV)>=0.2) %>%
      knitr::kable() %>% 
      kableExtra::kable_styling()
    
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Actual Data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---  
    FigS6A.data.for.saving<- All.Things %>% 
      filter(str_detect(Description,"naive|BIVIG",negate=T)) %>% 
      mutate_at(vars(starts_with("FI")),~ifelse(.<0,0,.)) %>% 
      select(-contains("Blank")) %>% 
      rename_at(vars(starts_with("FI")),~"FI") %>% 
      group_by(Description,What) %>% 
      summarize(Mean_val=mean(FI),
                TheWell=paste(Well,collapse=","),
                .groups="drop") %>% 
      left_join(Actual_CV %>% select(-N))

    
    
    
```

There is data that is above the CV cutoff of 0.2 that is dropped and then these observations were rerun. 

```{r cvanalysis, options}



ToDrop<-sum(FigS6A.data.for.saving$CV >0.20)

FigS6A.data.for.saving %>% filter(CV>=0.2) %>% 
  kable() %>% kable_styling(full_width = F)



```


Processing additional data

```{r processing more, options}

FigS6A.binding.analysis<-FigS6A.data.for.saving %>% 
  filter(CV<0.2) %>% 
  mutate(Description=str_remove_all(Description,"R")) %>% 
  mutate(Rabbit=str_split_fixed(Description,"_",2)[,1],
         Week=str_split_fixed(Description,"_",2)[,2]) %>% 
  mutate(TheBinding=str_split_fixed(What,"wk",2)[,2]) %>% 
  mutate(TheBinding=str_split_fixed(TheBinding,"14_",
                                    2)[,2]) %>% 
  mutate(TheBinding=str_remove_all(TheBinding,".xlsx")) %>% 
  mutate(TheBinding=str_remove_all(TheBinding,
                                   "(PL[[:alnum:]])")) %>% 
  mutate(TheBinding=str_remove_all(TheBinding,"_"))

FigS6A.binding.analysis<-FigS6A.binding.analysis %>% 
  mutate(TheBinding=ifelse(str_detect(TheBinding,"FcR"),
                           TheBinding,
                           paste0("FcR",TheBinding))) %>% 
  mutate(TheBinding=str_remove_all(TheBinding,
                                   "[[:blank:]]"))
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# If there is more than one (due to sample sample as opposed to the population sample for CV)
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

FigS6A_fin_binding<-FigS6A.binding.analysis %>% 
  mutate(DateRun=str_split_fixed(What,"_",2)[,1]) %>% 
  group_by(TheBinding,Week,Rabbit) %>% 
  arrange(desc(ymd(DateRun))) %>% 
  slice(1) %>% ungroup() %>% 
  select(Rabbit,Week,Value=Mean_val,TheBinding) %>% 
  left_join(OurVaccine.info)



```


## Figure S6B

```{r figs6B, options}


TheFile<-file.path(pathtofile,
                   "Figure4 additional/Figure4_FcgR_signaling_updated.xlsx")

Our.sheets<-excel_sheets(TheFile)


Our.data<-lapply(Our.sheets,function(x) read_excel(TheFile,sheet=x) %>% 
                   mutate(What=x))


FigS6B_FcR<-Our.data %>% bind_rows() %>% 
  group_by(`Animal ID`,What,Duplicate) %>% 
  summarize(AUC1=AUC(x=log10(Dilution),y=OD),.groups="drop") %>% 
  pivot_wider(values_from=AUC1,names_from=Duplicate)%>% 
  mutate(`Rabbit`=paste0("N",`Animal ID`)) %>% 
  left_join(OurVaccine.info)



```


## Figure S8A

```{r FigureS8A, options}


New.figS8A<-str_subset(list.files(file.path(pathtofile,
                                          "Figure4/")),"SPR")

FigS8A.save.spr<-read_excel(file.path(pathtofile,
                                    "Figure4/",New.figS8A))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get into form that shows whether or not at a bound
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

FigS8A.actual_save.spr<-FigS8A.save.spr %>% 
  mutate_at(c("Response","kd","Avidity"),~ifelse(.=="ND",NA,.)) %>% 
  pivot_longer(cols=c("kd","Avidity")) %>% 
  mutate(AtUpperBound=ifelse(is.na(value) & name=="kd",1,0)) %>% 
  mutate(AtLowerBound=ifelse(is.na(value) & name=="Avidity",
                             1,0)) %>% 
  mutate(Newvalue=parse_number(value)) %>% 
  group_by(name) %>% 
  mutate(Newvalue=ifelse(is.na(value) & name=="kd",max(Newvalue,na.rm=T)+1,Newvalue)) %>% 
  mutate(Newvalue=ifelse(is.na(value) & name=="Avidity",0,Newvalue)) %>% 
  select(Sample,Week,name,value,Newvalue,AtLowerBound,AtUpperBound) %>% 
  left_join(OurVaccine.info %>% rename("Sample"=Rabbit)) %>% 
  bind_rows(FigS8A.save.spr %>% 
              select(Sample,Week,Newvalue=Response) %>% 
              mutate(name="Response",
                     AtLowerBound=0,
                     AtUpperBound=0))




```



## Save it out

```{r saveout, echo=F}



FigS.additional<-list(FigS6A=FigS6A_fin_binding,
                      FigS6B_FcR=FigS6B_FcR,
                      FigS8A.actual_save.spr=FigS8A.actual_save.spr)


saveRDS(FigS.additional,
        file = file.path(pathtosave,
                         "0_data_processed_sup_Figures.RDS"))



```



# Session Info

```{r sessioninfo}
sessionInfo()
```