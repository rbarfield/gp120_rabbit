---
title: "Reviewer Requested Analyses for Supplement"
author: 
  - "Richard Barfield"
  - "Biostatistics, Epidemiology and Research Design (BERD) Core"
  - "Center for Human Systems Immunology (CHSI)"
date: "`r  Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r Baseinfo,eval=FALSE}
#General info ----------------------
#
# Created: 2022-05-05
#
# Author: Richard Barfield
#
# Program: Code/17_Additional_Requested_analyses
#
# Description: Additional requested analyses
#                
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
```

```{r libs,message=FALSE, warning=FALSE, include=F, results='asis'}


library(readxl)
library(coin)
library(knitr)
library(kableExtra)
library(table1)
library(tidyverse)

```

# Read in Data 

```{r loaddata}



pathtofile<-"Data/Original/"
pathtofile<-file.path(getwd(),"../",pathtofile)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Load the data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Rabbit data first
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
    File1<-"Supp Fig_anti-Q11 IgG response.xlsx"

    Rabbit.Data<-read_excel(file.path(pathtofile,File1))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Mouse Data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
    File2<-"Supp Fig_mouse gp120-Q11_unadjuvanted.xlsx"
    
    Mouse.Data<-read_excel(file.path(pathtofile,File2))
```

# Rabbit Data Supplementary Analysis




```{r visualzierabbit, options}

Rabbit.Data %>% 
  pivot_longer(cols=-c(`Animal ID`,Vaccine)) %>% 
  mutate(name=fct_reorder(name,value)) %>% 
  ggplot(aes(x=name,y=value,col=name))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position = position_jitter(0.01,seed=414))+
  scale_y_log10(breaks=c(0,5,10,15,20),labels=c(0,5,10,15,20))+
  theme(legend.position = "none")+
  xlab("")
  

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Connecting lines 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
 Rabbit.Data %>% 
  pivot_longer(cols=-c(`Animal ID`,Vaccine)) %>% 
  mutate(name=fct_reorder(name,value)) %>% 
  ggplot(aes(x=name,y=value,col=name))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position = position_jitter(0.01,seed=414))+
  scale_y_log10(breaks=c(0,5,10,15,20),labels=c(0,5,10,15,20))+
  theme(legend.position = "none")+
  xlab("")+
   geom_line(aes(group=`Animal ID`),col="black")
  
   


```



Is this wk0 anti-Q11 to wk14 anti-Q11 or wk0 anti-Q11 to wk14 anti-Q22

## Difference betweek wk0 anti-Q11 to wk14 anti-Q11


```{r test1, options}

Test1<-wilcox.test(Rabbit.Data$`wk0 anti-Q11`,Rabbit.Data$`wk14 anti-Q11`,paired = T)

Test1

```

Suggests a statistically significant difference between the wk14 anti-Q11 and the wk0 anti-Q11 data between the paired samples. We have a p-value of `r Test1$p.value`. Looking at the data, it appears that the response is higher at week 14. 




## Difference between wk0 anti-Q11 and wk14 anti-gp120


```{r test2, options}

Test2<-wilcox.test(Rabbit.Data$`wk14 anti-gp120`,Rabbit.Data$`wk14 anti-Q11`,paired = T)

Test2

```

Suggests a statistically significant difference between the wk14 anti-Q11 and the wk14 anti-gp120 data between the paired samples. We have a p-value of `r Test2$p.value`. Looking at the data, it appears that the response is higher at week 14 anti-gp120. 




# Mouse Data questions


```{r mousetest1, fig.width=10}

Mouse.Data %>% select(`Animal ID`,Vaccine, contains("IgG")) %>% 
  pivot_longer(cols=-c(`Animal ID`,Vaccine)) %>% 
  mutate(name=str_split_fixed(name,"[[:blank:]]",2)[,1]) %>% 
  mutate(name=fct_reorder(name,value)) %>% 
  ggplot(aes(x=Vaccine,y=value,col=Vaccine))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position = position_jitter(0.01,seed=414))+
  facet_wrap(~name,ncol=7)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Now the actual analysis 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

Mouse.Data %>% select(`Animal ID`,Vaccine, contains("IgG")) %>% 
  pivot_longer(cols=-c(`Animal ID`,Vaccine),names_to="Glycosylation") %>% 
  group_by(Glycosylation) %>% 
  summarize(pvalue_coin_exact=pvalue(wilcox_test(value~as.factor(Vaccine),
            distribution="exact"))[1],
            .groups="drop") %>% 
  mutate(FDRpvalue=p.adjust(pvalue_coin_exact,"BH")) %>% 
  mutate_if(is.numeric,signif,digits=3) %>% 
  kable() %>% 
  kable_styling(full_width = F)



NewBit<-Mouse.Data %>%
  select(`Animal ID`,Vaccine, contains("IgG")) %>% 
  rename_all(~str_squish(str_split_fixed(.,"IgG",2)[,1]))


TheForm<-paste0("~",paste(paste0("`",
                                 setdiff(colnames(NewBit),
                                  c("Animal ID","Vaccine")),
                                  "`"),
               collapse="+"),"|Vaccine")

table1::table1(formula(TheForm),data=NewBit,
               render.continuous=c(.="Median [Min, Max]"))
```


There was no significant differences between the groups via wilcoxon rank sum test. This lack of any statistical difference is likely due to the relatively small sample size. 



## Sensitivity Outlier removal

Dropping those with response lower than 1000.

Given that are sample size is now 4 mice with gp120 and 3 mice with gp120-Q11, we can not assess statistical significance. The smallest observable p-value under these circumstances is 0.0571. Therefore only qualitative statements or describing the data between the groups is applicable. 



```{r mousetest2, fig.width=10}

Mouse.Data %>%
  filter(`All peaks>1000`=="Y") %>% 
  select(`Animal ID`,Vaccine, contains("IgG")) %>% 
  pivot_longer(cols=-c(`Animal ID`,Vaccine)) %>% 
  mutate(name=str_split_fixed(name,"[[:blank:]]",2)[,1]) %>% 
  mutate(name=fct_reorder(name,value)) %>% 
  ggplot(aes(x=Vaccine,y=value,col=Vaccine))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position = position_jitter(0.01,seed=414))+
  facet_wrap(~name,ncol=7)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Will just do a Table 1
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---


NewBit<-Mouse.Data %>%
  filter(`All peaks>1000`=="Y") %>% 
  select(`Animal ID`,Vaccine, contains("IgG")) %>% 
  rename_all(~str_squish(str_split_fixed(.,"IgG",2)[,1]))


TheForm<-paste0("~",paste(paste0("`",
                                 setdiff(colnames(NewBit),
                                  c("Animal ID","Vaccine")),
                                  "`"),
               collapse="+"),"|Vaccine")

table1::table1(formula(TheForm),data=NewBit,
               render.continuous=c(.="Median [Min, Max]"))


```


# Session Info

```{r sessioninfo}
sessionInfo()
```
