---
title: "GP120-rabbit analysis-> Figure 3"
author: 
  - "Richard Barfield"
  - "Biostatistics, Epidemiology and Research Design (BERD) Core"
  - "Center for Human Systems Immunology (CHSI)"
date: "`r  Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r Baseinfo,eval=FALSE}
#General info ----------------------
#
# Created: 2022-02-03
#
# Author: Richard Barfield
#
# Program:/Code/12_Figure_3_analyses.R
# 
# Description: Analyses for Figure 3
# 
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
#--- --- --- --- --- --- --- --- --- --- --- --- --- 
```

```{r libs,message=FALSE, warning=FALSE, include=F, results='asis'}


library(DescTools)
library(coin)
library(ggfortify)
library(factoextra)
library(geepack)
library(gee)
library(geesmv)
library(ez)
library(DT)
library(nparLD)
library(readxl)
library(knitr)
library(kableExtra)
library(tidyverse)

```

# Introduction

Reading in and processing the data into an analytical form to be used.

# Path to Data

```{r loaddata}


pathtofile<-"Data/Processed/"
pathtofile<-file.path(getwd(),"../",pathtofile)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Load the data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

Fig3.data<-readRDS(file.path(pathtofile,
                             "0_data_processed_fig3.RDS"))

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# ADding information on what "vaccine group" in
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
OurVaccine.info<-read.delim(text = "Rabbit	Vaccine
N32330	gp120+STR8S-C (-Q11)
N32331	gp120+STR8S-C (-Q11)
N32332	gp120+STR8S-C (-Q11)
N32333	gp120+STR8S-C (-Q11)
N32334	gp120+STR8S-C (-Q11)
N32335	gp120+STR8S-C (-Q11)
N32336	gp120+STR8S-C (-Q11)
N32337	gp120+STR8S-C (-Q11)
N32338	gp120-Q11+STR8S-C (+Q11)
N32339	gp120-Q11+STR8S-C (+Q11)
N32340	gp120-Q11+STR8S-C (+Q11)
N32341	gp120-Q11+STR8S-C (+Q11)
N32342	gp120-Q11+STR8S-C (+Q11)
N32343	gp120-Q11+STR8S-C (+Q11)
N32344	gp120-Q11+STR8S-C (+Q11)
N32345	gp120-Q11+STR8S-C (+Q11)",sep="\t")


```

# Figure 3A



```{r Fig3additional, echo=F}

Fig3.add<-list.files(file.path(pathtofile,
                               "../Original/Figure3 additional"),
                      full.names = T)

NewData<-read_excel(Fig3.add)

NewData %>% 
  ggplot(aes(x=`Vaccine group`,y=`wk14 +IgG`))+
  geom_boxplot(outlier.shape = NA)+
  geom_point(position=position_jitter(0.02,seed=202))


NewPvalues<-NewData %>% 
   summarize(pvalue=pvalue(wilcox_test(`wk14 +IgG`~as.factor(`Vaccine group`),
            distribution="exact"))[1],
            .groups="drop")


```

In our analysis of this neutralizing data at week 14, (via wilcoxon rank sum test) the p-value is `r signif(NewPvalues$pvalue,3)`. 

# Figure 3B


Adding baseline value (week 0) as covariate. Assuming this effect is the same across different Antigens.

```{r analysis, echo=F}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Source function for performing analysis
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
source("1_general_code_for_calc_BC_variance.R")






#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Set up dataset
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
OGEE<-Fig3.data$Figure3_ADCP %>% 
  mutate(TimeWhat=interaction(What,Time)) %>% 
  mutate(TimeWhat=fct_reorder(TimeWhat,
                              as.numeric(str_remove_all(Time,"w")))) %>% 
  mutate(Rabbit=str_sub(ID,2,-1)) %>% 
  mutate(BB=log10(Mean)) 
 


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Processing so that can be passed on to the MyGee.Var.MD 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- 
NewGEE<-OGEE %>% filter(Time!="w0")  %>% 
  left_join(OGEE %>% filter(Time=="w0") %>% 
              dplyr::select(ID,What,BaseLine=BB))
NewGEE$subject<-NewGEE$Rabbit
NewGEE$id<-NewGEE$Rabbit
NewGEE<-NewGEE[order(NewGEE$subject),]


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# The Formula
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
my.formula<-BB~-1+Time+BaseLine+What*Vaccination  


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get varaince and estimates
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
NewResus<-MyGee.Var.MD(my.formula,id="id",family=stats::gaussian,
                       data=NewGEE)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Set up the contrast matrices 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Contrast.est2<-matrix(0,nrow=3,ncol=length(NewResus$beta_est))

Contrast.est2[1:3,which(str_detect(names(NewResus$beta_est),"Vaccination") &
                          str_detect(names(NewResus$beta_est),"What",negate=T))]<-1

Contrast.est2[2,which(str_detect(names(NewResus$beta_est),"Vaccination") &
                          str_detect(names(NewResus$beta_est),"WhatMN"))]<-1
Contrast.est2[3,which(str_detect(names(NewResus$beta_est),"Vaccination") &
                          str_detect(names(NewResus$beta_est),"WhatCH505"))]<-1


Our.Var<-Contrast.est2 %*% NewResus$cov.beta  %*% t(Contrast.est2)

Our.New.effects<-Contrast.est2 %*%NewResus$beta_est


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get tests and p-values 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
Overall.test<-t(Our.New.effects) %*% solve(Our.Var) %*% Our.New.effects
Overall.Pvalue<-pchisq(Overall.test[1,1],df=3,lower.tail=F)

Ind.Pvalues<-pchisq(Our.New.effects^2/diag(Our.Var),df=1,lower.tail=F)

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Display output 
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
data.frame(What=c("1086c gp120 K160N: Q11 vs no",
                  "MN gp120: Q11 vs no",
                  "CH505 gp120: Q11 vs no"),stringsAsFactors = F) %>% 
  mutate(Effect_Estimate=Our.New.effects,
         Effect_Std=sqrt(diag(Our.Var)),
         Effect_Pvalue=Ind.Pvalues,
         Effect_Adjust_Pvalue=p.adjust(Ind.Pvalues,"bonferroni")) %>% 
  DT::datatable(rownames = F) %>% 
  DT::formatSignif(c("Effect_Estimate",
                     "Effect_Std",
                     "Effect_Pvalue",
                     "Effect_Adjust_Pvalue"))

```

We see a marginal association in 1086. Evaluate in more detail (after dividing by baseline-well subtracting the log of the baseline).

```{r eval1086, echo=F}
NewGEE %>% filter(What=="1086c gp120 K160N") %>% 
  mutate(BB=BB-BaseLine) %>% 
  group_by(What,Time) %>% 
  summarize(Pvalue_coin_exact=pvalue(wilcox_test(BB~as.factor(Vaccination),
                                                 distribution="exact"))[1],
            .groups="drop") %>% 
  mutate(Time=factor(Time,levels=c("w0","w2","w8","w14"))) %>% 
  arrange(Time) %>% 
  kable() %>% kable_styling(full_width = F)
```



So, there is some evidence of a difference at Week 2.






# Figure 3C ADCC


Due to running permutations this part will take time. 
```{r a21adcc, echo=F}

Fig3.data$Figure3_ADCC %>% 
  mutate(Week=fct_reorder(Week,as.numeric(str_remove_all(Week,"w")))) %>% 
  pivot_longer(cols=c(`Maxium activity`,Titer)) %>% 
  ggplot(aes(x=Week,y=value,col=Vaccine,group=`Animal ID`))+
  geom_point()+
  geom_line()+
  facet_wrap(~What*name,nrow=2,ncol=2,scales="free")

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get in right format
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
ForAnalysis<-Fig3.data$Figure3_ADCC %>% 
  pivot_longer(cols=c(`Maxium activity`,Titer)) %>% 
  rename("subject"=`Animal ID`) %>% 
  left_join(OurVaccine.info %>% rename("subject"=Rabbit,
                                       OVaccine=Vaccine)) 


     #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
     # End point titer gp120 coated
     #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---    
            Resu1.titer.gp120<-nparLD(value~Week+Vaccine,time1.order = c("w4","w10","w21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=ForAnalysis %>% filter(What=="gp120-coated cell assay" &
                                                        name=="Titer"))
                  
          set.seed(11)
          trash<-capture.output(perm.resu.titer.gp120<-ezPerm(data=ForAnalysis %>% 
                                                     filter(What=="gp120-coated cell assay" &
                                                        name=="Titer") %>% 
                                                     mutate(Week=factor(Week,levels=c("w4","w10","w21"))),
                                                   dv = value,
                                                   wid=subject,
                                                   within = Week,between = Vaccine,
                 perms = 10000) )
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # End point titer HIV coated
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
          Resu1.titer.HIV<-nparLD(value~Week+Vaccine,time1.order = c("w2","w8","w14","w21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=ForAnalysis %>% filter(What!="gp120-coated cell assay" &
                                                        name=="Titer"))
                  
          set.seed(115)
          trash<-capture.output(perm.resu.titer.HIV<-ezPerm(data=ForAnalysis %>% 
                                                     filter(What!="gp120-coated cell assay" &
                                                        name=="Titer") %>% 
                                                                                                                                               mutate(Week=factor(Week,levels=c("w2","w8","w14","w21"))),
                                                   dv = value,
                                                   wid=subject,
                                                   within = Week,between = Vaccine,
                 perms = 10000) )
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # Max activity gp120 coated 
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
          Resu1.max.gp120<-nparLD(value~Week+Vaccine,time1.order = c("w4","w10","w21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=ForAnalysis %>% filter(What=="gp120-coated cell assay" &
                                                        name!="Titer"))
                  
          set.seed(12)
          trash<-capture.output(perm.resu.max.gp120<-ezPerm(data=ForAnalysis %>% 
                                                              filter(What=="gp120-coated cell assay" &
                                                                       name!="Titer") %>% 
                                                     mutate(Week=factor(Week,levels=c("w4","w10","w21"))),
                                                   dv = value,
                                                   wid=subject,
                                                   within = Week,between = Vaccine,
                 perms = 10000) )


      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
      # Max activity HIV coated 
      #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
          Resu1.max.HIV<-nparLD(value~Week+Vaccine,time1.order = c("w2","w8","w14","w21"),
                          subject = "subject",order.warning = F,
                          description = F,
                          data=ForAnalysis %>% filter(What!="gp120-coated cell assay" &
                                                        name!="Titer"))
                  
          set.seed(12)
          trash<-capture.output(perm.resu.max.HIV<-ezPerm(data=ForAnalysis %>% 
                                                              filter(What!="gp120-coated cell assay" &
                                                                       name!="Titer") %>% 
                                                     mutate(Week=factor(Week,levels=c("w2","w8","w14","w21"))),
                                                   dv = value,
                                                   wid=subject,
                                                   within = Week,between = Vaccine,
                 perms = 10000) )

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Put All Results together
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
          
      data.frame(Pvalues_nparld=c(signif(Resu1.titer.gp120$ANOVA.test.mod.Box[4],3),
                             signif(Resu1.titer.HIV$ANOVA.test.mod.Box[4],3),
                             signif(Resu1.max.gp120$ANOVA.test.mod.Box[4],3),
                             signif(Resu1.max.HIV$ANOVA.test.mod.Box[4],3)))  %>% 
        mutate(Pvalues_perm=c(perm.resu.titer.gp120$p[1],
                              perm.resu.titer.HIV$p[1],
                              perm.resu.max.gp120$p[1],
                              perm.resu.max.HIV$p[1])) %>% 
        mutate(FinPvalue=ifelse(Pvalues_perm==0,Pvalues_perm,Pvalues_nparld)) %>%
        mutate(FDR_Pvalue=p.adjust(FinPvalue,"BH")) %>% 
        dplyr::select(-FinPvalue) %>% 
        mutate(Pvalues_perm=ifelse(Pvalues_perm==0,"<0.001",Pvalues_perm)) %>% 
        mutate(FDR_Pvalue=signif(FDR_Pvalue,3)) %>% 
        mutate(FDR_Pvalue=ifelse(FDR_Pvalue==0,"<0.001",FDR_Pvalue)) %>% 
        mutate(What=c("GP120 coated","HIV coated","GP120 coated","HIV coated"),
               Variable=c("Titer","Titer","Max Activity","Max Activity")) %>% 
        dplyr::select(What,Variable,everything()) %>% 
        kable() %>% kable_styling(full_width = F)
        
          
```

Everything is significant. The permutation was done as the Titer analysis produced singular covariance matrix.
 
Doing individual tests. Here we used Bonferroni adjustment.

```{r indtest, echo=F,warning=F}

IndResults<-ForAnalysis %>% group_by(Week,What,name) %>% 
  summarize(Pvalue_coin_exact=pvalue(wilcox_test(value~as.factor(Vaccine),
                                                 distribution="exact"))[1],
            .groups="drop")

IndResults %>% mutate(Week=factor(Week,levels=c("w2","w4","w8","w10","w14","w21"))) %>% 
  arrange(Week,What,name) %>% 
  mutate_at(vars(starts_with("Pvalue")),~ifelse(.<0.05/n(),
                                                paste0(signif(.,3),"*"),
                                                signif(.,3))) %>% 
  DT::datatable(rownames=F)
  


```

If have \* after it is significant at 0.05/20.





# Session Info

```{r sessioninfo}
sessionInfo()
```
